name: C/C++ æŒç»­é›†æˆ

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  # æ·»åŠ  release äº‹ä»¶æ”¯æŒ
  release:
    types: [created]

jobs:
  build-and-test:
    name: æ„å»ºå’Œæµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
    
    - name: å®‰è£…ä¾èµ–é¡¹
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ cmake make sqlite3 libsqlite3-dev
    
    - name: ä½¿ç”¨Makeæ„å»º
      run: make
    
    - name: æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
      run: |
        if [ -f "phone_forensic" ]; then
          ./phone_forensic --help || echo "ç¨‹åºè¿è¡ŒæˆåŠŸ"
          echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶æµ‹è¯•é€šè¿‡"
        else
          echo "âŒ å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°"
          exit 1
        fi
    
    - name: æ¸…ç†æ„å»ºæ–‡ä»¶
      run: make clean

  linux-release:
    name: Linuxå‘è¡Œç‰ˆæ‰“åŒ…
    runs-on: ubuntu-latest
    needs: build-and-test
    # ä¿®å¤æ¡ä»¶ï¼šåŒæ—¶æ”¯æŒæ ‡ç­¾æ¨é€å’ŒReleaseåˆ›å»º
    if: |
      (startsWith(github.ref, 'refs/tags/') || github.event_name == 'release') &&
      needs.build-and-test.result == 'success'
    
    steps:
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
    
    - name: è·å–ç‰ˆæœ¬å·
      id: get-version
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          VERSION="${{ github.event.release.tag_name }}"
          # å¦‚æœæ ‡ç­¾ä»¥vå¼€å¤´ï¼Œå»æ‰vå‰ç¼€
          VERSION=${VERSION#v}
        else
          VERSION="${GITHUB_REF#refs/tags/}"
          VERSION=${VERSION#v}
        fi
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "version=${VERSION}" >> $GITHUB_ENV
        echo "ğŸ“¦ ç‰ˆæœ¬å·: ${VERSION}"
    
    - name: å®‰è£…æ‰“åŒ…å·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ cmake make libsqlite3-dev dpkg-dev
        
    - name: æ„å»ºå‘å¸ƒç‰ˆæœ¬
      run: |
        make clean
        CXXFLAGS="-std=c++17 -Wall -O3 -DNDEBUG" make
        strip phone_forensic
    
    - name: åˆ—å‡ºæ„å»ºæ–‡ä»¶
      run: ls -la phone_forensic && file phone_forensic
    
    - name: åˆ›å»ºDEBè½¯ä»¶åŒ…
      run: |
        mkdir -p package/usr/local/bin
        mkdir -p package/DEBIAN
        cp phone_forensic package/usr/local/bin/
        
        cat > package/DEBIAN/control <<EOF
        Package: lqz-forensic
        Version: ${{ env.version }}
        Section: utils
        Priority: optional
        Architecture: amd64
        Maintainer: é’Ÿæ™ºå¼º <johnmelodymel@qq.com>
        Description: Android Device Forensic Tool
         çµå–è¯æ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§ä¸”ä¸“ä¸šçš„å®‰å“è®¾å¤‡æ•°æ®å–è¯å·¥å…·ï¼Œä¸“é—¨ä¸ºæ‰§æ³•éƒ¨é—¨ã€å¸æ³•æœºæ„å’Œå®‰å…¨è°ƒæŸ¥äººå‘˜è®¾è®¡å¼€å‘ã€‚
        EOF
        
        dpkg-deb --build package lqz-forensic_${{ env.version }}_amd64.deb
        echo "âœ… DEBåŒ…åˆ›å»ºå®Œæˆ"
        ls -la *.deb
    
    - name: åˆ›å»ºé€šç”¨å‹ç¼©åŒ…
      run: |
        DIR_NAME="lqz-${{ env.version }}-linux-amd64"
        
        mkdir -p "${DIR_NAME}"
        cp phone_forensic "${DIR_NAME}/"
        cp README.md LICENSE "${DIR_NAME}/"
        
        cat > "${DIR_NAME}/README-zh.txt" <<EOF
        çµå–è¯ ${{ env.version }} - Linuxç‰ˆæœ¬
        
        è¿è¡Œæ–¹æ³•ï¼š
        1. ç¡®ä¿å·²å®‰è£…ADBå·¥å…·
        2. åœ¨ç»ˆç«¯ä¸­è¿è¡Œï¼š./phone_forensic
        
        æŠ€æœ¯æ”¯æŒï¼š
        - å¼€å‘è€…ï¼šé’Ÿæ™ºå¼º <johnmelodymel@qq.com>
        - GitHub: https://github.com/ctkqiang/LQZ
        EOF
        
        tar czf "${DIR_NAME}.tar.gz" "${DIR_NAME}/"
        echo "âœ… é€šç”¨å‹ç¼©åŒ…åˆ›å»ºå®Œæˆ"
        ls -la *.tar.gz
    
    - name: ä¸Šä¼ åˆ°GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          lqz-forensic_*.deb
          lqz-*-linux-amd64.tar.gz
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  windows-release:
    name: Windowsç‰ˆæœ¬æ‰“åŒ…
    runs-on: windows-latest
    needs: build-and-test
    # ä¿®å¤æ¡ä»¶ï¼šåŒæ—¶æ”¯æŒæ ‡ç­¾æ¨é€å’ŒReleaseåˆ›å»º
    if: |
      (startsWith(github.ref, 'refs/tags/') || github.event_name == 'release') &&
      needs.build-and-test.result == 'success'
    
    steps:
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
    
    - name: è·å–ç‰ˆæœ¬å·
      id: get-version
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          VERSION="${{ github.event.release.tag_name }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        # å»æ‰vå‰ç¼€ï¼ˆå¦‚æœæœ‰ï¼‰
        VERSION=${VERSION#v}
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "version=${VERSION}" >> $GITHUB_ENV
        echo "version=${VERSION}" | Out-File -FilePath $env:GITHUB_ENV -Append
    
    - name: è®¾ç½®MSYS2å’ŒMinGWç¯å¢ƒ
      uses: msys2/setup-msys2@v2
      with:
        update: true
        install: mingw-w64-x86_64-gcc mingw-w64-x86_64-sqlite3
    
    - name: ç¼–è¯‘Windowså¯æ‰§è¡Œæ–‡ä»¶
      shell: msys2 {0}
      run: |
        x86_64-w64-mingw32-g++ -std=c++17 -Wall -O3 -static \
          main.cpp model/model.cpp view/view.cpp controller/controller.cpp \
          -o phone_forensic.exe -lsqlite3 -lws2_32
        
        echo "âœ… Windowså¯æ‰§è¡Œæ–‡ä»¶ç¼–è¯‘å®Œæˆ"
        ls -la *.exe
    
    - name: åˆ›å»ºWindowså®‰è£…åŒ…
      shell: powershell
      run: |
        $Version = "${{ env.version }}"
        $FolderName = "lqz-$Version-windows-amd64"
        
        Write-Host "ğŸ“¦ åˆ›å»ºWindowså®‰è£…åŒ…: $FolderName"
        
        New-Item -ItemType Directory -Force -Path $FolderName
        
        Copy-Item "phone_forensic.exe" "$FolderName/"
        Copy-Item "README.md" "$FolderName/"
        Copy-Item "LICENSE" "$FolderName/"
        
        # åˆ›å»ºè¿è¡Œæ‰¹å¤„ç†æ–‡ä»¶
        @"
        @echo off
        chcp 65001 >nul
        echo.
        echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        echo â•‘        çµå–è¯ - å®‰å“å–è¯å·¥å…·          â•‘
        echo â•‘        ç‰ˆæœ¬: $Version               â•‘
        echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        echo.
        echo ä½¿ç”¨è¯´æ˜:
        echo 1. ç¡®ä¿å·²å®‰è£…ADBå·¥å…·å¹¶æ·»åŠ åˆ°ç³»ç»ŸPATH
        echo 2. é€šè¿‡USBè¿æ¥Androidè®¾å¤‡å¹¶å¼€å¯USBè°ƒè¯•
        echo 3. åŒå‡»æ­¤æ‰¹å¤„ç†æ–‡ä»¶è¿è¡Œç¨‹åº
        echo.
        echo æŠ€æœ¯æ”¯æŒ: é’Ÿæ™ºå¼º <johnmelodymel@qq.com>
        echo GitHub: https://github.com/ctkqiang/LQZ
        echo.
        pause
        start phone_forensic.exe
        "@ | Out-File -FilePath "$FolderName\run-lqz.bat" -Encoding ASCII
        
        # åˆ›å»ºè¯´æ˜æ–‡ä»¶
        @"
        çµå–è¯ $Version - Windowsç‰ˆæœ¬
        
        è¿è¡Œæ–¹æ³•ï¼š
        1. åŒå‡»"run-lqz.bat"æ–‡ä»¶
        2. æˆ–ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œ: phone_forensic.exe
        
        ç³»ç»Ÿè¦æ±‚ï¼š
        - Windows 7 64ä½æˆ–æ›´é«˜ç‰ˆæœ¬
        
        æŠ€æœ¯æ”¯æŒï¼š
        - å¼€å‘è€…ï¼šé’Ÿæ™ºå¼º <johnmelodymel@qq.com>
        - GitHub: https://github.com/ctkqiang/LQZ
        - QQäº¤æµç¾¤: 934810107
        "@ | Out-File -FilePath "$FolderName\README-zh.txt" -Encoding UTF8
        
        # åˆ›å»ºZIPå‹ç¼©åŒ…
        Compress-Archive -Path "$FolderName\*" -DestinationPath "$FolderName.zip"
        
        Write-Host "âœ… Windowså®‰è£…åŒ…åˆ›å»ºå®Œæˆ: $FolderName.zip"
        Get-ChildItem *.zip
    
    - name: ä¸Šä¼ Windowsç‰ˆæœ¬åˆ°GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: lqz-*-windows-amd64.zip
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}